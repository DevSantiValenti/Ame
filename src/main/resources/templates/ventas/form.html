<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${titulo}"></title>
</head>

<body class="ms-5 me-5 my-3">
    <div layout:fragment="contenido">

        <form th:action="@{/ventas/guardar}" th:object="${venta}" method="post" style="object-fit: cover;">
            <div class="card">
                <div class="card-header">
                    <div class="card-tittle">
                        <h4 class="text-primary" th:text="${titulo}"></h4>
                    </div>
                </div>
                <div class="card-body  mx-2">
                    <!-- Formulario Maestro-Detalle -->

                    <!-- Encabezado de la venta -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <small class="text-primary" style="font-weight: bold;">Fecha y Hora</small>
                                <br>
                                <label th:field="*{fechaHora}"
                                    th:text="*{#temporals.format(fechaHora, 'dd/MM/yyyy HH:mm')}"></label>
                                <!--El * es un modificador de acceso-->
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <small class="text-primary" style="font-weight: bold;">Descripción</small>
                                <br>
                                <textarea class="form-control" rows="3" th:field="*{descripcionGral}"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-primary" style="font-weight: bold;">Total</small>
                            <br>
                            <h4 id="total" class="text-success">$0</h4>
                        </div>
                        <div class="col-md-4">
                            <small class="text-primary" style="font-weight: bold;">Vendedora</small>
                            <br>
                            <select name="usu" id="usu" class="form-select" th:field="*{usuario}">
                                <option th:each="u : ${usuario}" th:value="${u.id}" th:text="${u}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <small class="text-primary" style="font-weight: bold;">Tipo de Pago</small>
                            <br>
                            <select name="met" id="met" class="form-select" th:field="*{metodoPago}">
                                <option th:each="m : ${metodoPago}" th:value="${m.id}" th:text="${m}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>
                                <input type="checkbox" style="transform: scale(2); margin-top: 35px;" id="mayorista"
                                    onclick="LineasUtil.toggleMayorista()">
                                <span style="font-size: 1.3em; margin-left: 10px;">Mayorista</span>
                            </label>
                        </div>
                        <div class="col-md-4">
                            <small class="text-primary" style="font-weight: bold;">Cliente</small>
                            <br>
                            <select id="clientesDES" class="form-select" th:field="*{cliente}" style="width: fit-content;">
                                <option th:each="c : ${cliente}" th:value="${c.id}" th:text="${c.dni} + ' - ' + ${c.nombre}"></option>
                            </select>
                        </div>

                    </div>
                    <hr class="my-5">
                    <!-- Detalle de la venta(Cuerpo o Linea) -->

                    <!-- Buscador de Productos para añadirlos al detalle de la venta -->

                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <small class="text-primary" style="font-weight: bold;">Buscar Producto</small>
                                <br>
                                <input type="search" id="buscar" class="form-control"
                                    placeholder="Cod. Barras o Descripción">
                            </div>
                        </div>
                    </div>
                    <!-- Campo oculto para enviar el total al backend -->
                    <input type="hidden" id="totalHidden" name="total" value="">

                    <!-- Tabla de Lineas de Venta -->
                    <table class="table table-bordered table-hover table-striped mt-4" id="tabla-productos">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio Mayorista</th>
                                <th>Precio Minorista</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <!-- Tabla Auxiliar(Plantilla para las lineas) -->
                    <table class="d-none">
                        <tbody id="lineas">
                            <tr id="fila_{ID}">
                                <td class="d-none">
                                    <input type="hidden" value="{ID}" name="item_id[]"> Un arreglo de id
                                </td>
                                <td>
                                    {DESCRIPCION}
                                </td>
                                <td>
                                    {PRECIOMAY}
                                </td>
                                <td>
                                    {PRECIOMIN}
                                </td>
                                <td>
                                    <input type="number"
                                        onchange="LineasUtil.calcularSubtotal({ID}, {PRECIOMIN}, this.value);" value="1"
                                        min="1" name="cantidad_[]" id="cantidad_{ID}" class="cantidad" data-id="{ID}">
                                    <!-- name es el nombre del array y el id, es la cantidad del producto-->
                                </td>
                                <td>
                                    <span id="subtotal_{ID}">0</span>
                                </td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-danger" onclick="LineasUtil.borrarLinea({ID});">
                                        <i class='bx bxs-trash bx-tada'></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <a th:href="@{/ventas/listado}" class="btn btn-outline-danger">Volver</a>
                    <button type="submit" class="btn btn-primary float-end">Guardar</button>
                </div>
            </div>
        </form>

    </div>

    <!-- Mis JS -->
    <script th:fragment="js" th:src="@{/js/ventas-form.js}"></script>

</body>

</html>